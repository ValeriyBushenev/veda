@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix v-fc: <http://semantic-machines.com/veda/veda-function-create/> .
@prefix v-fs: <http://semantic-machines.com/veda/veda-search/> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cfg: <http://semantic-machines.com/veda/config/> .

<http://semantic-machines.com/veda/veda-function-property-authorization>
  rdf:type owl:Ontology ;
  rdfs:label "Онтология системы Veda. Функция 'Авторизация по значению свойства/выражения'"@ru ;
  rdfs:label "Veda system ontology. Function 'Authorization on predicate/expression value'"@en ;
#  owl:versionInfo "1.3" ;
  v-s:loadPriority 6 ;
.

# ------------------------------------------------------------ КЛАССЫ --

v-s:GroupGenerator
  rdf:type owl:Class ;
  rdfs:label "Генератор групп авторизации"@ru ;
  rdfs:label "Auth groups generator"@en ;
  rdfs:comment "Используется для распределения индивидов в группы авторизации на основе вычисленного от объекта значения предиката/выражения."@ru ;
  rdfs:comment "Used to distribute individuals to auth groups based on calculated value predicate or expression."@en ;
  rdfs:subClassOf v-s:SystemThing ;
  v-ui:hasTemplate v-s:GroupGeneratorTemplate ;
.

v-s:authClass
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:GroupGenerator ;
  rdfs:label "Авторизуемый класс"@ru ;
  rdfs:label "Authorized class"@en ;
  rdfs:range rdfs:Class ;
.

v-s:authProperty
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:GroupGenerator ;
  rdfs:label "Авторизуемое свойство"@ru ;
  rdfs:label "Authorized property"@en ;
  rdfs:range rdf:Property ;
.

v-s:authExpression
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-s:GroupGenerator ;
  rdfs:label "Авторизуемое выражение"@ru ;
  rdfs:label "Authorized expression"@en ;
  rdfs:range xsd:string ;
.

v-s:authValue
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-s:GroupGenerator ;
  rdfs:domain v-s:PermissionGenerator ;
  rdfs:label "Авторизуемое значение"@ru ;
  rdfs:label "Authorized value"@en ;
  rdfs:range rdfs:Resource ;
.

v-s:PermissionGenerator
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:PermissionStatement ;
  rdfs:label "Генератор прав"@ru ;
  rdfs:label "Permissions generator"@en ;
  v-ui:hasTemplate v-s:PermissionGeneratorTemplate ;
.

v-s:objectGroupGenerator
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:PermissionGenerator ;
  rdfs:label "Генератор группы объекта"@ru ;
  rdfs:label "Object group generator"@en ;
  rdfs:range v-s:GroupGenerator ;
.

v-s:objectGroupGeneratorValue
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:PermissionGenerator ;
  rdfs:label "Значение генератора группы объекта"@ru ;
  rdfs:label "Object group generator value"@en ;
  rdfs:range rdfs:Resource ;
.

v-s:subjectGroupGenerator
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:PermissionGenerator ;
  rdfs:label "Генератор группы субъекта"@ru ;
  rdfs:label "Subject group generator"@en ;
  rdfs:range v-s:GroupGenerator ;
.

v-s:subjectGroupGeneratorValue
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:PermissionGenerator ;
  rdfs:label "Значение генератора группы субъекта"@ru ;
  rdfs:label "Subject group generator value"@en ;
  rdfs:range rdfs:Resource ;
.

# ------------------------------------------------------------ ШАБЛОНЫ --

v-s:GroupGeneratorUri
  rdf:type v-s:Bundle ;
  rdfs:label "URI группы авторизации для выбранного значения"@ru ;
  rdfs:label "Auth group URI for chosen value"@en ;
.

v-s:GroupGeneratorTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:GroupGenerator ;
  rdfs:label "Шаблон для класса v-s:GroupGenerator"@ru ;
  rdfs:label "Template for v-s:GroupGenerator class"@en ;
  v-ui:template """
<script>
  //# sourceURL=v-s:GroupGeneratorTemplate_pre
</script>
<div class="container sheet">
  <h2 about="v-s:GroupGenerator" property="rdfs:label"></h2>
  <hr>
  <em about="rdfs:label" property="rdfs:label"></em>
  <div property="rdfs:label" class="view -edit -search"></div>
  <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>

  <em about="rdfs:comment" property="rdfs:label"></em>
  <div property="rdfs:comment" class="view -edit -search"></div>
  <veda-control data-type="text" rows="2" property="rdfs:comment" class="-view edit search"></veda-control>

  <em about="v-s:authClass" property="rdfs:label"></em>
  <div about="@" rel="v-s:authClass" data-template="v-ui:LabelTemplate" class="view edit -search"></div>
  <div rel="v-s:authClass" data-template="v-ui:LabelTemplate" class="-view -edit search"></div>
  <veda-control data-type="link" rel="v-s:authClass" class="-view edit search fulltext"></veda-control>

  <em about="v-s:authProperty" property="rdfs:label"></em>
  <div about="@" rel="v-s:authProperty" data-template="v-ui:LabelTemplate" class="view edit -search"></div>
  <div rel="v-s:authProperty" data-template="v-ui:LabelTemplate" class="-view -edit search"></div>
  <veda-control data-type="link" rel="v-s:authProperty" class="-view edit search fulltext"></veda-control>

  <em about="v-s:authExpression" property="rdfs:label"></em>
  <div property="v-s:authExpression" class="view -edit -search"></div>
  <veda-control data-type="text" rows="2" property="v-s:authExpression" class="-view edit search"></veda-control>

  <em about="v-s:authValue" property="rdfs:label"></em>
  <div property="v-s:authValue" class="view -edit -search"></div>
  <veda-control data-type="generic" property="v-s:authValue" class="-view edit search"></veda-control>
  <em about="v-s:GroupGeneratorUri" property="rdfs:label"></em>
  <code class="group-uri"></code>
  <br>
  <br>
  <div class="actions view edit -search">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
  </div>
</div>
<script>
  individual.on("propertyModified", handler);
  template.one("remove", function () {
    individual.off("propertyModified", handler);
  });
  handler();

  function handler() {
    var $groupUri = $(".group-uri", template);
    if ( individual.hasValue("v-s:authValue") ) {
      var group_concat_uri = individual.id + " " + individual["v-s:authValue"][0].toString();
      var hash = Sha256.hash(group_concat_uri).substring(32);
      var group_uri = "d:grp-" + hash;
      $groupUri.text(group_uri);
    } else {
      $groupUri.text("");
    }
  }

  //# sourceURL=v-s:GroupGeneratorTemplate_post
</script>
""" ;
.

v-s:PermissionGeneratorTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:GroupGenerator ;
  rdfs:label "Шаблон для класса v-s:PermissionGenerator"@ru ;
  rdfs:label "Template for v-s:PermissionGenerator class"@en ;
  v-ui:template """
<script>
  //# sourceURL=v-s:PermissionGeneratorTemplate_pre
</script>
<div class="container sheet">
  <h2 about="v-s:PermissionGenerator" property="rdfs:label"></h2>
  <hr>
  <em about="rdfs:label" property="rdfs:label"></em>
  <div property="rdfs:label" class="view -edit -search"></div>
  <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>

  <em about="rdfs:comment" property="rdfs:label"></em>
  <div property="rdfs:comment" class="view -edit -search"></div>
  <veda-control data-type="text" rows="2" property="rdfs:comment" class="-view edit search"></veda-control>

  <em about="v-s:permissionSubject" property="rdfs:label"></em>
  <div rel="v-s:permissionSubject" data-template="v-ui:LabelLinkTemplate" class="view -edit search"></div>
  <veda-control data-type="link" rel="v-s:permissionSubject" class="-view edit search fulltext dropdown"></veda-control>

  <em about="v-s:subjectGroupGenerator" property="rdfs:label"></em>
  <div rel="v-s:subjectGroupGenerator" data-template="v-ui:LabelLinkTemplate" class="view -edit search"></div>
  <veda-control data-type="link" rel="v-s:subjectGroupGenerator" class="-view edit search fulltext dropdown"></veda-control>

  <em about="v-s:subjectGroupGeneratorValue" property="rdfs:label"></em>
  <div property="v-s:subjectGroupGeneratorValue" class="view -edit -search"></div>
  <veda-control data-type="generic" property="v-s:subjectGroupGeneratorValue" class="-view edit search"></veda-control>

  <hr>

  <em about="v-s:permissionObject" property="rdfs:label"></em>
  <div rel="v-s:permissionObject" data-template="v-ui:LabelLinkTemplate" class="view -edit search"></div>
  <veda-control data-type="link" rel="v-s:permissionObject" class="-view edit search fulltext dropdown"></veda-control>

  <em about="v-s:objectGroupGenerator" property="rdfs:label"></em>
  <div rel="v-s:objectGroupGenerator" data-template="v-ui:LabelLinkTemplate" class="view -edit search"></div>
  <veda-control data-type="link" rel="v-s:objectGroupGenerator" class="-view edit search fulltext dropdown"></veda-control>

  <em about="v-s:objectGroupGeneratorValue" property="rdfs:label"></em>
  <div property="v-s:objectGroupGeneratorValue" class="view -edit -search"></div>
  <veda-control data-type="generic" property="v-s:objectGroupGeneratorValue" class="-view edit search"></veda-control>

  <hr>

  <div class="checkbox">
    <label>
      <veda-control property="v-s:canCreate" data-type="boolean"></veda-control>
      <em about="v-s:canCreate" property="rdfs:label"></em>
    </label>
  </div>
  <div class="checkbox">
    <label>
      <veda-control property="v-s:canRead" data-type="boolean"></veda-control>
      <em about="v-s:canRead" property="rdfs:label"></em>
    </label>
  </div>
  <div class="checkbox">
    <label>
      <veda-control property="v-s:canUpdate" data-type="boolean"></veda-control>
      <em about="v-s:canUpdate" property="rdfs:label"></em>
    </label>
  </div>
  <div class="checkbox">
    <label>
      <veda-control property="v-s:canDelete" data-type="boolean"></veda-control>
      <em about="v-s:canDelete" property="rdfs:label"></em>
    </label>
  </div>
  <br>
  <div class="actions view edit -search">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
  </div>
</div>
<script>
  //# sourceURL=v-s:PermissionGeneratorTemplate_post
</script>
""" ;
.

# ------------- РЕЕСТРЫ ---------------

v-s:GroupGeneratorBlank
  a v-fc:Blank ;
  rdfs:label "Генератор групп авторизации"@ru ;
  rdfs:label "Auth group generator"@en ;
  v-fc:targetType v-s:GroupGenerator ;
.

v-s:GroupGeneratorRegistry
  a v-fs:AttributiveSearch;
  rdfs:label "Генераторы групп авторизации"@ru ;
  rdfs:label "Auth group generators"@en ;
  v-fs:searchBlank v-s:GroupGeneratorBlank ;
  v-fs:searchBlankTemplate v-s:GroupGeneratorTemplate ;
  v-fs:searchResultTemplate v-s:GroupGeneratorRegistryResultTemplate ;
.

v-s:GroupGeneratorRegistryResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон результатов реестра v-s:GroupGenerator"@ru ;
  rdfs:label "v-s:GroupGenerator registry result template"@en ;
  v-ui:template """
<table class="table table-bordered">
  <thead class="result-header">
    <tr>
      <th colspan="11" about="v-s:GroupGenerator" property="rdfs:label"></th>
    </tr>
    <tr class="active">
      <th width="1%"><input type="checkbox" class="toggle-select-all"></th>
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th class="orderby" data-orderby="v-s:authClass"><span about="v-s:authClass" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:authProperty"><span about="v-s:authProperty" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:authExpression"><span about="v-s:authExpression" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:authValue"><span about="v-s:authValue" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:creator"><span about="v-s:creator" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:created"><span about="v-s:created" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td><input type="checkbox" class="toggle-select"></td>
      <td class="serial-number"></td>
      <td><a href="#/@" class="glyphicon glyphicon-search"></a></td>
      <td about="@" rel="v-s:authClass" data-template="v-ui:LabelTemplate"></td>
      <td about="@" rel="v-s:authProperty" data-template="v-ui:LabelTemplate"></td>
      <td about="@" property="v-s:authExpression"></td>
      <td about="@" property="v-s:authValue"></td>
      <td about="@" rel="v-s:creator" data-template="v-ui:LabelTemplate"></td>
      <td about="@" property="v-s:created"></td>
    </tr>
  </tbody>
</table>
  """ ;
.

v-s:PermissionGeneratorBlank
  a v-fc:Blank ;
  rdfs:label "Генератор прав"@ru ;
  rdfs:label "Permissions generator"@en ;
  v-fc:targetType v-s:PermissionGenerator ;
.

v-s:PermissionGeneratorRegistry
  a v-fs:AttributiveSearch;
  rdfs:label "Генераторы прав"@ru ;
  rdfs:label "Permissions generators"@en ;
  v-fs:searchBlank v-s:PermissionGeneratorBlank ;
  v-fs:searchBlankTemplate v-s:PermissionGeneratorTemplate ;
  v-fs:searchResultTemplate v-s:PermissionGeneratorRegistryResultTemplate ;
.

v-s:PermissionGeneratorRegistryResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон результатов реестра v-s:PermissionGenerator"@ru ;
  rdfs:label "v-s:PermissionGenerator registry result template"@en ;
  v-ui:template """
<table class="table table-bordered">
  <thead class="result-header">
    <tr>
      <th colspan="12" about="v-s:PermissionGenerator" property="rdfs:label"></th>
    </tr>
    <tr class="active">
      <th width="1%"><input type="checkbox" class="toggle-select-all"></th>
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th><span about="v-s:permissionSubject" property="rdfs:label"></span></th>
      <th><span about="v-s:subjectGroupGenerator" property="rdfs:label"></span></th>
      <th><span about="v-s:subjectGroupGeneratorValue" property="rdfs:label"></span></th>
      <th><span about="v-s:Rights" property="rdfs:label"></span></th>
      <th><span about="v-s:permissionObject" property="rdfs:label"></span></th>
      <th><span about="v-s:objectGroupGenerator" property="rdfs:label"></span></th>
      <th><span about="v-s:objectGroupGeneratorValue" property="rdfs:label"></span></th>
      <th><span about="v-s:creator" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:created"><span about="v-s:created" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td><input type="checkbox" class="toggle-select"></td>
      <td class="serial-number"></td>
      <td><a href="#/@" class="glyphicon glyphicon-search"></a></td>
      <td about="@" rel="v-s:permissionSubject" data-template="v-ui:LabelLinkTemplate"></td>
      <td about="@" rel="v-s:subjectGroupGenerator" data-template="v-ui:LabelLinkTemplate"></td>
      <td about="@" property="v-s:subjectGroupGeneratorValue"></td>
      <td class="rights"></td>
      <td about="@" rel="v-s:permissionObject" data-template="v-ui:LabelLinkTemplate"></td>
      <td about="@" rel="v-s:ObjectGroupGenerator" data-template="v-ui:LabelLinkTemplate"></td>
      <td about="@" property="v-s:ObjectGroupGeneratorValue"></td>
      <td about="@" rel="v-s:creator" data-template="v-ui:LabelTemplate"></td>
      <td about="@" property="v-s:created"></td>
    </tr>
    <script>
      var rights = "";
      rights += (this.hasValue("v-s:canCreate", true) ? "C" : "");
      rights += (this.hasValue("v-s:canRead", true)   ? "R" : "");
      rights += (this.hasValue("v-s:canUpdate", true) ? "U" : "");
      rights += (this.hasValue("v-s:canDelete", true) ? "D" : "");
      $(".rights", template).text(rights);
    </script>
  </tbody>
</table>
  """ ;
.

# ------------------------------------------------------------ УПРАВЛЕНИЕ ПРАВАМИ --

v-s:GroupGenerator_BaseUser
  rdf:type v-s:Group ;
  rdfs:label "Основные пользователи v-s:GroupGenerator"@ru ;
  rdfs:label "Users v-s:GroupGenerator"@en ;
.

v-s:GroupGenerator_Admin
  rdf:type v-s:Group ;
  rdfs:label "Администраторы v-s:GroupGenerator"@ru ;
  rdfs:label "Administrators v-s:GroupGenerator"@en ;
.

v-s:GroupGenerator_permission1
  rdf:type v-s:PermissionStatement ;
  v-s:permissionObject v-s:GroupGenerator ;
  v-s:permissionObject v-s:GroupGenerator_group ;
  v-s:permissionObject v-s:GroupGeneratorBlank ;
  v-s:permissionObject v-s:GroupGeneratorRegistry ;
  v-s:permissionObject v-s:GroupGeneratorRegistryBlank ;
  v-s:permissionSubject v-s:GroupGenerator_BaseUser ;
  v-s:canRead "true"^^xsd:boolean ;
  rdfs:label "R. Все пользователи. Индивиды v-s:GroupGenerator" ;
.

v-s:GroupGenerator_permission2
  rdf:type v-s:PermissionStatement ;
  v-s:permissionObject v-s:GroupGeneratorUser ;
  v-s:permissionSubject v-s:GroupGenerator_BaseUser ;
  v-s:canCreate "true"^^xsd:boolean ;
  rdfs:label "C. Админы. Класс v-s:GroupGenerator" ;
.

v-s:GroupGenerator_permission3
  rdf:type v-s:PermissionStatement ;
  v-s:permissionObject v-s:GroupGenerator ;
  v-s:permissionObject v-s:GroupGenerator_group ;
  v-s:permissionObject v-s:GroupGeneratorUserBlank ;
  v-s:permissionObject v-s:GroupGeneratorRegistry ;
  v-s:permissionObject v-s:GroupGeneratorRegistryBlank ;
  v-s:permissionObject v-s:GroupGeneratorAdminBlank ;
  v-s:permissionObject v-s:GroupGeneratorAdmin ;
  v-s:permissionObject v-s:GroupGeneratorAdmin_group ;
  v-s:permissionSubject v-s:GroupGenerator_Admin ;
  v-s:canCreate "true"^^xsd:boolean ;
  v-s:canRead "true"^^xsd:boolean ;
  v-s:canUpdate "true"^^xsd:boolean ;
  v-s:canDelete "true"^^xsd:boolean ;
  rdfs:label "CRUD. Админы. Индивиды v-s:GroupGenerator" ;
.

v-s:AllUsersGroup_RequestDelegation_BaseUser_membership
  rdf:type v-s:Membership ;
  v-s:memberOf v-s:GroupGenerator_BaseUser ;
  v-s:resource cfg:AllUsersGroup ;
  v-s:resource v-s:GroupGenerator_Admin ;
  rdfs:label "Все пользователи входят в группу Основные пользователи v-s:GroupGenerator" ;
.

# ------------------------------------------------------------ СЕРВЕРНЫЕ СКРИПТЫ --

cfg:Event_GroupGenerator
  rdf:type v-s:Event ;
  v-s:author cfg:VedaSystem ;
  rdfs:label "Скрипт распределения по группам авторизации" ;
  v-s:triggerByType v-s:ClassAuthorized ;
  v-s:runAt "V8.LowPriority" ;
  v-s:script """
/* Available variables:
 * ticket = superuser ticket
 * document = captured document
 * user_uri = user whose actions triggered event
 * prev_state = previous state of the captured document
 * _event_id = id of the event to prevent cycles in triggers. Must be passed to every function that modifies DB.
 * parent_script_id = id of the parent script that triggered this event.
 * parent_document_id = id of the document that triggered this event.
 * super_classes = super classes of the document.
 */

try {
  veda.GroupGenerators = veda.GroupGenerators || query(veda.ticket, "'rdf:type' === 'v-s:GroupGenerator'").result.reduce(function (acc, generator_uri) {
    var generator = get_individual(veda.ticket, generator_uri);
    var authClass = veda.Util.getUri(generator["v-s:authClass"]);
    var authProperty = veda.Util.getUri(generator["v-s:authProperty"]);
    var authExpression = veda.Util.getFirstValue(generator["v-s:authExpression"]);
    var authValue = veda.Util.getFirstValue(generator["v-s:authValue"]);
    var fn;
    if (authProperty) {
      fn = new Function("veda", "return ( veda.Util.getFirstValue(this['" + authProperty + "']) );");
    } else if (authExpression) {
      fn = new Function("veda", "return " + authExpression);
    }
    fn.generator = generator_uri;
    fn.value = authValue;
    acc[authClass] = (acc[authClass] || []).concat(fn);
    return acc;
  }, {});

  var type = veda.Util.getUri(document["rdf:type"]);
  var _super = JSON.parse(super_classes);
  _super.push(type);

  for (var i = 0, _class; (_class = _super[i]); i++) {
    if (_class in veda.GroupGenerators) {
      var fns = veda.GroupGenerators[_class];
      for (var j = 0, fn; (fn = fns[j]); j++) {
        var fn_value;
        if (fn.value === undefined) {
          fn_value = fn.call(document, veda);
          if (fn_value === undefined) { continue; }
        } else {
          fn_value = (fn.value.toString() === fn.call(document, veda).toString()) && fn.value;
        }
        var group_concat_uri = fn.generator + " " + fn_value.toString();
        var hash = Sha256.hash(group_concat_uri).substring(32);
        var group_uri = "d:grp-" + hash;
        var group = get_individual(veda.ticket, group_uri);
        if ( !group ) {
          group = {
            "@": group_uri,
            "rdf:type": veda.Util.newUri("v-s:Group"),
            "rdfs:label": veda.Util.newStr("Auth group. Generator: " + fn.generator + ", value: " + fn_value)
          };
          put_individual(veda.ticket, group);
        }
        var mem_uri = "d:mem-" + Sha256.hash(document["@"] + " " + group_uri).substring(32);
        var mem = get_individual(veda.ticket, mem_uri);
        if ( !mem ) {
          mem = {
            "@": mem_uri,
            "rdf:type": veda.Util.newUri("v-s:Membership"),
            "rdfs:label": veda.Util.newStr("Membership. Generator: " + fn.generator + ", value: " + fn_value),
            "v-s:resource": veda.Util.newUri(document["@"]),
            "v-s:memberOf": veda.Util.newUri(group_uri)
          }
          put_individual(veda.ticket, mem);
        }
      }
    }
  }
} catch (error) {
  console.log("Error: ", error);
}
  """ ;
.

cfg:Event_GroupGeneratorsReset
  rdf:type v-s:Event ;
  v-s:author cfg:VedaSystem ;
  rdfs:label "Скрипт обработки генераторов групп авторизации" ;
  v-s:triggerByType v-s:GroupGenerator ;
  v-s:script """
veda.GroupGenerators = undefined;
  """ ;
.

cfg:Event_PermissionGenerator
  rdf:type v-s:Event ;
  v-s:author cfg:VedaSystem ;
  rdfs:label "Скрипт обработки генераторов прав" ;
  v-s:triggerByType v-s:PermissionGenerator ;
  v-s:runAt "V8.LowPriority" ;
  v-s:script """
/* Available variables:
 * ticket = superuser ticket
 * document = captured document
 * user_uri = user whose actions triggered event
 * prev_state = previous state of the captured document
 * _event_id = id of the event to prevent cycles in triggers. Must be passed to every function that modifies DB.
 * parent_script_id = id of the parent script that triggered this event.
 * parent_document_id = id of the document that triggered this event.
 * super_classes = super classes of the document.
 */
try {
  var permissionGenerator = document;
  var subjectGroup_uri;
  var objectGroup_uri;
  if (veda.Util.hasValue(permissionGenerator, "v-s:permissionSubject")) {
    subjectGroup_uri = veda.Util.getUri(permissionGenerator["v-s:permissionSubject"]);
  } else if (veda.Util.hasValue(permissionGenerator, "v-s:subjectGroupGenerator") && veda.Util.hasValue(permissionGenerator, "v-s:subjectGroupGeneratorValue")) {
    var subjectGroupGenerator = veda.Util.getUri(permissionGenerator["v-s:subjectGroupGenerator"]);
    var subjectGroupGeneratorValue = permissionGenerator["v-s:subjectGroupGeneratorValue"][0].data;
    var subjectGroup_concat_uri = subjectGroupGenerator + " " + subjectGroupGeneratorValue;
    var subjectGroup_hash = Sha256.hash(subjectGroup_concat_uri).substring(32);
    subjectGroup_uri = "d:grp-" + subjectGroup_hash;
  }
  if (veda.Util.hasValue(permissionGenerator, "v-s:permissionObject")) {
    objectGroup_uri = veda.Util.getUri(permissionGenerator["v-s:permissionObject"]);
  } else if (veda.Util.hasValue(permissionGenerator, "v-s:objectGroupGenerator") && veda.Util.hasValue(permissionGenerator, "v-s:objectGroupGeneratorValue")) {
    var objectGroupGenerator = veda.Util.getUri(permissionGenerator["v-s:objectGroupGenerator"]);
    var objectGroupGeneratorValue = permissionGenerator["v-s:objectGroupGeneratorValue"][0].data;
    var objectGroup_concat_uri = objectGroupGenerator + " " + objectGroupGeneratorValue;
    var objectGroup_hash = Sha256.hash(objectGroup_concat_uri).substring(32);
    objectGroup_uri = "d:grp-" + objectGroup_hash;
  }
  if (subjectGroup_uri && objectGroup_uri) {
    var permission_concat_uri = subjectGroup_uri + " " + objectGroup_uri;
    var permission_hash = Sha256.hash(permission_concat_uri).substring(32);
    var permission_uri = "d:per-" + permission_hash;
    var permission = {
      "@": permission_uri,
      "rdf:type": veda.Util.newUri("v-s:PermissionStatement"),
      "rdfs:label": veda.Util.newStr("Permission. Permission generator: " + permissionGenerator["@"] + ", group generator: " + groupGenerator + ", value: " + authValue),
      "v-s:permissionSubject": veda.Util.newUri(subjectGroup_uri),
      "v-s:permissionObject": veda.Util.newUri(objectGroup_uri),
      "v-s:canCreate": permissionGenerator["v-s:canCreate"],
      "v-s:canRead": permissionGenerator["v-s:canRead"],
      "v-s:canUpdate": permissionGenerator["v-s:canUpdate"],
      "v-s:canDelete": permissionGenerator["v-s:canDelete"]
    };
    put_individual(ticket, permission);
  }
} catch (error) {
  console.log("Error: ", error);
}
  """ ;
.

##### Class groups generator #####

v-s:GroupGenerator_Class
  rdf:type v-s:GroupGenerator ;
  v-s:authClass v-s:ClassAuthorized ;
  v-s:authProperty rdf:type ;
  rdfs:label "Auth group generator: put individual to class group" ;
.

v-s:PermissionGenerator_AllUsersGroup_D_Person
  rdf:type v-s:PermissionGenerator ;
  rdfs:label "Permission generator: cfg:AllUsersGroup '---D' v-s:Person class individuals" ;
  v-s:permissionSubject cfg:AllUsersGroup ;
  v-s:canDelete true ;
  v-s:objectGroupGenerator v-s:GroupGenerator_Class ;
  v-s:objectGroupGeneratorValue v-s:Person ;
.

v-s:GroupGenerator_Person_label_Administrator
  rdf:type v-s:GroupGenerator ;
  rdfs:label "Auth group generator: person label is 'Administrator'" ;
  v-s:authClass v-s:Person ;
  v-s:authExpression """
(function () {
  console.log("!!!!!!!!!!!");
  return veda.Util.hasValue(this, "rdfs:label", {data: "Administrator ", type: "String"});
})();
  """ ;
.

v-s:PermissionGenerator_AllUsersGroup_D_Person_label_Administrator
  rdf:type v-s:PermissionGenerator ;
  rdfs:label "Permission generator: cfg:AllUsersGroup '---D' v-s:Person if 'Administrator' label" ;
  v-s:permissionSubject cfg:AllUsersGroup ;
  v-s:canDelete true ;
  v-s:objectGroupGenerator v-s:GroupGenerator_Person_label_Administrator ;
  v-s:objectGroupGeneratorValue true ;
.

v-s:PermissionGenerator_AllUsersGroup_C_Person_label_Administrator
  rdf:type v-s:PermissionGenerator ;
  rdfs:label "Permission generator: cfg:AllUsersGroup 'C---' v-s:Person if not 'Administrator' label" ;
  v-s:permissionSubject cfg:AllUsersGroup ;
  v-s:canCreate true ;
  v-s:objectGroupGenerator v-s:GroupGenerator_Person_label_Administrator ;
  v-s:objectGroupGeneratorValue false ;
.

# Сделал первый подход к мандатам (автоматическое распределение индивидов по авторизационным группам).
#
# В принципе получается универсальный инструмент.
# Хочу перевести на него наши существующие скрипты по созданию групп и включению в них индивидов (например, группа индивидов классов, иерархия групп индивидов классов в соответствии с  иерархией классов, иерархия групп орг. структуры).
#
# Работает так:
# 1) Есть скрипт, обрабатывающий объекты класса v-s:ClassAuthorized (просто для теста, от него наследуется v-s:UserThing).
# 2) Скрипт ведет в инстансе JsVm список всех существующих генераторов групп авторизации.
# 3) Для каждого индивида пойманного скриптом проверяется наличие генератора. Проверка делается для класса и всех суперклассов индивида. Подходящие генераторы выполняются по отношению к индивиду.
# 4) Каждый генератор описывает:
#   - целевой класс, для которого выполняется генератор;
#   - целевое свойство (для распределение по значению свойства индивида).
#   - целевое выражение - скрипт, который должен вернуть произвольное значение на основе индивида.
#   - целевое значение - если указано, то производится проверка на соответствие целевого значения и значения целевого свойства или целевого выражения. Если значения совпадают, объект помещается в соответствующую группу.
# Целевое свойство и целевое выражение взаимно исключающие атрибуты, приоритет имеет целевое свойство.
# 5) Задача генератора - вычислить целевое значение, на основании которого будет вычислена существующая авторизационная группа или создана новая. Таким образом количество групп авторизации порождаемое генератором равно количеству уникальных целевых значений.
# 6) Uri Авторизационной группы вычисляется так:
# "d:grp-" + Sha256.hash(generator_uri + " " value).substr(32)
# 7) Объект добавляется в вычисленную (созданную) группу.
# Uri Записи о включении в группу вычисляется так:
# "d:mem-" + Sha256.hash(object_uri + " " + group_uri).substring(32)
# 8) Права можно выдавать традиционным способом - зная uri группы объекта и субъекта, создать запись о правах.
# 9) Или создавать генераторы прав, где указываются не группы субъекта и объекта, а их генераторы и соответствующие целевые значения. Это позволит не вычислять вручную uri групп для прав. На основе генераторов прав создаются обычные записи о правах (1 к 1).
#
# Таким образом, предлагаемый механизм является надстройкой над уже существующей системой авторизации и фактически повторяет возможности мандатов в СЭД.
